# 2048 クローン

３４１行のコードです。２時間くらいです。  
たいしたことないと思いますが、説明残しておきます。

## 起動の仕方・操作方法

* 「sample.html」を起動
* マウスかタッチでスワイプすることで動かせる  
マウスはクリック開始点と終了点から計算します  
タッチも結局、開始点と終了点から計算してます 

## ごめんなさい

突貫にてハードコードばかりです。
* 結局４じゃないと動きません。ところどころループに４や１６があるので。  
特に306行目が4×4向けのハードコード。ごめんなさい。
* 画面サイズもそんなに自由にいじれません。  
特に219行目。サイズによって2種類のフォントサイズしかないので。ごめんなさい。

## 1行目ー61行目

メインループなど

* 11、16行目：変な名前ですけど、これが大事な変数（クラスの実体）
* 13行目：window.onload なので、ここから動くぐらいに見てもらえれば
* 22行目：コントローラー系の制御

* 29-46行目：ここがメインループ。30FPSのつもりで
* 48-60行目：蛇足です。（自分の携帯想定で）ウインドウサイズを切り替えている

## 62行目ー176行目

マウスイベントやタッチイベントをさばいている。

* 117行目まで：EventListner 系の処理
* 121-123行目：スワイプのためのグローバルな変数管理  
	* 160行目 mvfunc 内で、173行目の pconf.move(ddd); を呼んでおり、  
これが配列操作です。
	* あとは、開始点と終了点で何となく判断。  
XとYの絶対値が50以上無いと斜め（もしくは動いていない）とみなして処理しない。


## 177行目ー341行目

* draw()、メインループから30FPSで呼ばれる
	* 描画がメイン。今の状態(最新の配列)を表示するだけ。配列を変更しない。  
変なタイミングで配列を参照するかもしれない。  
まあでも30FPSなので上書きされる。いつかは正しく表示される、追いつく。
	* Line 189-234 だけ描画。let val = this.tbl[ii]; をループで16個表示しているだけ。

以下、this.tbl を変更しているロジック

* move()が、外部からの配列変更。引数は237行目の通り、１－４を期待している。

* tblconvert()、がメインのロジック  
4×4の配列、を動かす方向を考慮して 向きのある４つの配列とみなし、
それに対する操作をcvt() と設計しました。

* データ的に、以下の特性。
	* 配列が、左上から右に ０，１，２，３となっている。
	* 行や列に独立の特性がある。  
下に動かす場合、1列だけに着目すれば良い。  
１２、８、４、０ の４つだけ。ほかの数字に影響しない。
	* １２のほうに集まるというのもポイント、向きの特性がある。

* cvt()、4つの配列を操作する関数。２７行。  
ココがメインかもしれない。これを美しく書ければ良さそう。
	* １．０を無視して数字を前に詰める
	* ２．合成 しながら詰めなおす
	* ３．残りをゼロ埋め

